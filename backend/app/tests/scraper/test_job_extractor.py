import pytest
from unittest.mock import patch
from bs4 import BeautifulSoup
from app.models import JobPostings, SeniorityLevelsEnum, EmploymentTypesEnum
from sqlmodel import Session, select
from app.scraper.extractors.job_postings_extractor import JobPostingDataExtractor

HTML_CONTENT = """
\n\n    \n<!---->    \n    \n\n    \n    <section class="top-card-layout container-lined overflow-hidden babybear:rounded-[0px]">\n        \n      \n\n      <div class="top-card-layout__card relative p-2 papabear:p-details-container-padding">\n            \n        \n      <a href="https://www.linkedin.com/company/altana-ai?trk=public_jobs_topcard_logo" target="_self" data-tracking-control-name="public_jobs_topcard_logo" data-tracking-will-navigate>\n        \n          \n      <img class="artdeco-entity-image artdeco-entity-image--square-5\n          " data-delayed-url="https://media.licdn.com/dms/image/C560BAQGmTXLPNqSBow/company-logo_100_100/0/1631659746156/altana_ai_logo?e=2147483647&amp;v=beta&amp;t=0ZD5p-9rtu_gwcn76oPLtQcKm9WTh126PKlk6o4yWaQ" data-ghost-classes="artdeco-entity-image--ghost" data-ghost-url="https://static.licdn.com/aero-v1/sc/h/9rxpcj33wtsq3w7nxb3u3ku6e" alt="Altana">\n  \n        \n      </a>\n  \n      \n\n          <div class="top-card-layout__entity-info-container flex flex-wrap papabear:flex-nowrap">\n            <div class="top-card-layout__entity-info flex-grow flex-shrink-0 basis-0 babybear:flex-none babybear:w-full babybear:flex-none babybear:w-full">\n                  \n          <a href="https://www.linkedin.com/jobs/view/lead-sales-engineer-enterprise-at-altana-3909920006?trk=public_jobs_topcard-title" data-tracking-control-name="public_jobs_topcard-title" class="topcard__link" data-tracking-will-navigate>\n            <h2 class="top-card-layout__title font-sans text-lg papabear:text-xl font-bold leading-open text-color-text mb-0 topcard__title">Lead Sales Engineer, Enterprise</h2>\n          </a>\n      \n<!---->\n<!---->\n                <h4 class="top-card-layout__second-subline font-sans text-sm leading-open text-color-text-low-emphasis mt-0.5">\n                  \n        <div class="topcard__flavor-row">\n          <span class="topcard__flavor">\n              <a class="topcard__org-name-link topcard__flavor--black-link" data-tracking-control-name="public_jobs_topcard-org-name" data-tracking-will-navigate href="https://www.linkedin.com/company/altana-ai?trk=public_jobs_topcard-org-name" rel="noopener" target="_blank">\n                Altana\n              </a>\n          </span>\n            <span class="topcard__flavor topcard__flavor--bullet">\n              Washington, DC\n            </span>\n        </div>\n        <div class="topcard__flavor-row">\n          \n        <span class="posted-time-ago__text topcard__flavor--metadata">\n          \n\n    \n    \n    \n    \n    \n    \n    \n    \n    \n    \n    \n    \n    \n    \n    \n    \n\n    \n    \n    \n    \n    \n    \n    \n    \n    \n    \n    \n    \n    \n    \n\n      1 week ago\n  \n        </span>\n  \n          \n    \n    \n    \n\n        <span class="num-applicants__caption topcard__flavor--metadata topcard__flavor--bullet">\n          32 applicants\n        </span>\n  \n        </div>\n          \n    \n\n    \n      \n    <div class="face-pile flex see-who-was-hired">\n      <div class="face-pile__images-container self-start flex-shrink-0 mr-1 leading-[1]">\n          \n      <img class="inline-block relative\n          rounded-[50%]\n          w-4 h-4\n           face-pile__image border-1 border-solid border-color-transparent -ml-2 first:ml-0" data-delayed-url="https://static.licdn.com/aero-v1/sc/h/5kmvlcys0cgehw7e3ojvz5yuk" data-ghost-classes="bg-color-entity-ghost-background" data-ghost-url="https://static.licdn.com/aero-v1/sc/h/9c8pery4andzj6ohjkjp54ma2" alt>\n  \n          \n      <img class="inline-block relative\n          rounded-[50%]\n          w-4 h-4\n           face-pile__image border-1 border-solid border-color-transparent -ml-2 first:ml-0" data-delayed-url="https://static.licdn.com/aero-v1/sc/h/dbyylwnsp3dbiscb831jwsr32" data-ghost-classes="bg-color-entity-ghost-background" data-ghost-url="https://static.licdn.com/aero-v1/sc/h/9c8pery4andzj6ohjkjp54ma2" alt>\n  \n          \n      <img class="inline-block relative\n          rounded-[50%]\n          w-4 h-4\n           face-pile__image border-1 border-solid border-color-transparent -ml-2 first:ml-0" data-delayed-url="https://static.licdn.com/aero-v1/sc/h/aemitl4w713xg3xvy9bcrecox" data-ghost-classes="bg-color-entity-ghost-background" data-ghost-url="https://static.licdn.com/aero-v1/sc/h/9c8pery4andzj6ohjkjp54ma2" alt>\n  \n      </div>\n          <a class="face-pile__cta self-center link-no-visited-state" href="https://www.linkedin.com/login?session_redirect=https%3A%2F%2Fwww%2Elinkedin%2Ecom%2Fsearch%2Fresults%2Fpeople%2F%3FfacetCurrentCompany%3D14031310&amp;emailAddress=&amp;fromSignIn=&amp;trk=public_jobs_see-who-was-hired_people-search-link_face-pile-cta" data-tracking-control-name="public_jobs_see-who-was-hired_people-search-link_face-pile-cta" data-tracking-will-navigate>\n            See who Altana has hired for this role\n          </a>\n    </div>\n  \n  \n  \n<!---->      \n                </h4>\n\n              <div class="top-card-layout__cta-container flex flex-wrap mt-0.5 papabear:mt-0 ml-[-12px]">\n                    \n          \n    \n\n      <button class="apply-button apply-button--default top-card-layout__cta mt-2 ml-1.5 h-auto babybear:flex-auto top-card-layout__cta--primary btn-md btn-primary" data-reference-id="dxSuWia/TGmrpNHSP+FUIw==" data-tracking-id="oaPisZfRQbeIUBrngBXNtw==" data-tracking-control-name="public_jobs_apply-link-onsite">\n                Apply\n      </button>\n  \n      \n\n                    \n          <button class="top-card-layout__cta mt-2 ml-1.5 h-auto babybear:flex-auto top-card-layout__cta--secondary btn-md btn-secondary save-job-modal-outlet" data-modal="save-job-modal-outlet" data-impression-id="public_jobs_topcard-save-job" data-tracking-control-name="public_jobs_topcard-save-job">\n            Save\n          </button>\n          \n    \n\n    \n\n    \n    <div class>\n<!---->\n      <div id="save-job-modal" class="modal save-job-modal " data-outlet="save-job-modal-outlet">\n<!---->        <div class="modal__overlay flex items-center bg-color-background-scrim justify-center fixed bottom-0 left-0 right-0 top-0 opacity-0 invisible pointer-events-none z-[1000] transition-[opacity] ease-[cubic-bezier(0.25,0.1,0.25,1.0)] duration-[0.17s]\n            py-4\n            " aria-hidden="true">\n          <section aria-modal="true" role="dialog" aria-labelledby="save-job-modal-modal-header" tabindex="-1" class="max-h-full modal__wrapper overflow-auto p-0 bg-color-surface max-w-[1128px] min-h-[160px] relative scale-[0.25] shadow-sm shadow-color-border-faint transition-[transform] ease-[cubic-bezier(0.25,0.1,0.25,1.0)] duration-[0.33s] focus:outline-0\n              \n              w-[1128px] mamabear:w-[744px] babybear:w-[360px]\n              \n              rounded-md">\n              <header class="modal__header flex items-center justify-between py-1.5 px-3\n                  ">\n                  <h2 id="save-job-modal-modal-header" class="modal__title font-normal leading-open text-color-text text-lg">Save job</h2>\n                  <button class="modal__dismiss modal__dismiss--with-icon btn-tertiary h-[40px] w-[40px] p-0 rounded-full indent-0\n                      " aria-label="Dismiss" data-tracking-control-name="public_jobs_save-job-modal_modal_dismiss" type="button">\n                      <icon class="modal__dismiss-icon relative top-[2px]" data-delayed-url="https://static.licdn.com/aero-v1/sc/h/gs508lg3t2o81tq7pmcgn6m2"></icon>\n                  </button>\n<!---->              </header>\n            <div class="modal__main w-full ">\n              \n        \n    <div class="loader loader--absolute">\n      <div class="loader__container mb-2 overflow-hidden">\n        <icon class="loader__icon inline-block loader__icon--muted text-color-icon-active" data-delayed-url="https://static.licdn.com/aero-v1/sc/h/ddi43qwelxeqjxdd45pe3fvs1" data-svg-class-name="loader__icon-svg--small fill-currentColor h-[30px] min-h-[30px] w-[30px] min-w-[30px]"></icon>\n      </div>\n    </div>\n  \n        \n    \n    \n    \n    \n    \n    \n\n    <code id="i18n_save_job_form_email_check_error" style="display: none"><!--"We’re sorry, something went wrong on our end. Please try again."--></code>\n\n    \n    \n    \n\n    <div class="email-input-page save-job-form-page">\n      \n      <form class="email-input-page__content-new-user">\n        <div class="email-input-page__content">\n          <h3 class="email-input-page__header">\n            \n        <figure class="save-job-form__inbug">\n          <icon data-delayed-url="https://static.licdn.com/aero-v1/sc/h/ercwkzy8m5jnkaliyweviswct" data-svg-class-name="save-job-form__inbug-icon"></icon>\n        </figure>\n        Save this job with your existing LinkedIn profile, or create a new one.\n      \n          </h3>\n          <span class="email-input-page__body">\n            \n        Your job seeking activity is only visible to you.\n      \n          </span>\n          \n    <div class="mt-1.5" data-js-module-id="guest-input">\n      <div class="flex flex-col">\n        <label class="input-label mb-1" for="public_jobs_save-job_email-input">\n          Email\n        </label>\n        <div class="text-input flex">\n          <input class="text-color-text font-sans text-md outline-0 bg-color-transparent grow" autocomplete="off" id="public_jobs_save-job_email-input" name="email-input-page__input" placeholder="Email address" required data-tracking-control-name="public_jobs_save-job_enter-email" type="text">\n          \n        </div>\n      </div>\n\n      <p class="input-helper mt-1.5" for="public_jobs_save-job_email-input" role="alert" data-js-module-id="guest-input__message"></p>\n    </div>\n  \n\n          <code id="email-input-page-error-message" style="display: none"><!--"Please enter a valid email address."--></code>\n        </div>\n        \n        <footer class="save-job-form__footer">\n          <button class="save-job-form__button" data-tracking-control-name="public_jobs_save-job-form-continue" type="submit">\n            Continue\n          </button>\n        </footer>\n      \n      </form>\n      \n    \n\n    <div class="welcome-back-sign-in-form welcome-back-sign-in-form--hidden" data-impression-id="save-job-sign-in-form">\n      <h3 class="welcome-back-sign-in-form__header">\n        Welcome back\n      </h3>\n\n        <p class="welcome-back-sign-in-form__subline">\n          \n          \n        Sign in to save <b>Lead Sales Engineer, Enterprise</b> at <b>Altana</b>.\n      \n        \n        </p>\n\n      \n    \n    \n    \n    \n    \n    \n    \n    \n    \n    \n\n    <code id="i18n_sign_in_form_show_text" style="display: none"><!--"Show"--></code>\n    <code id="i18n_sign_in_form_show_label" style="display: none"><!--"Show your LinkedIn password"--></code>\n    <code id="i18n_sign_in_form_hide_text" style="display: none"><!--"Hide"--></code>\n    <code id="i18n_sign_in_form_hide_label" style="display: none"><!--"Hide your LinkedIn password"--></code>\n\n    \n    <code id="i18n_username_error_empty" style="display: none"><!--"Please enter an email address or phone number"--></code>\n    \n    <code id="i18n_username_error_too_long" style="display: none"><!--"Email or phone number must be between 3 to 128 characters"--></code>\n    <code id="i18n_username_error_too_short" style="display: none"><!--"Email or phone number must be between 3 to 128 characters"--></code>\n\n    \n    <code id="i18n_password_error_empty" style="display: none"><!--"Please enter a password"--></code>\n    \n    <code id="i18n_password_error_too_short" style="display: none"><!--"The password you provided must have at least 6 characters"--></code>\n    \n    <code id="i18n_password_error_too_long" style="display: none"><!--"The password you provided must have at most 400 characters"--></code>\n\n<!---->    <form data-id="sign-in-form" action="https://www.linkedin.com/uas/login-submit" method="post" novalidate class="save-job-form-sign-in-form">\n      <input name="loginCsrfParam" value="c812d2db-adb6-41ed-89fd-9a940189a6c0" type="hidden">\n\n      <div class="flex flex-col">\n        \n    <div class="mt-1.5" data-js-module-id="guest-input">\n      <div class="flex flex-col">\n        <label class="input-label mb-1" for="session_key">\n          Email or phone\n        </label>\n        <div class="text-input flex">\n          <input class="text-color-text font-sans text-md outline-0 bg-color-transparent grow" autocomplete="username" id="session_key" name="session_key" required data-tracking-control-name="public_jobs_save-job_sign-in-session-key" data-tracking-client-ingraph type="text">\n          \n        </div>\n      </div>\n\n      <p class="input-helper mt-1.5" for="session_key" role="alert" data-js-module-id="guest-input__message"></p>\n    </div>\n  \n\n        \n    <div class="mt-1.5" data-js-module-id="guest-input">\n      <div class="flex flex-col">\n        <label class="input-label mb-1" for="session_password">\n          Password\n        </label>\n        <div class="text-input flex">\n          <input class="text-color-text font-sans text-md outline-0 bg-color-transparent grow" autocomplete="current-password" id="session_password" name="session_password" required data-tracking-control-name="public_jobs_save-job_sign-in-password" data-tracking-client-ingraph type="password">\n          \n            <button aria-live="assertive" aria-relevant="text" data-id="sign-in-form__password-visibility-toggle" class="font-sans text-md font-bold text-color-action z-10 ml-[12px] hover:cursor-pointer" aria-label="Show your LinkedIn password" data-tracking-control-name="public_jobs_save-job_sign-in-password-visibility-toggle-btn" type="button">Show</button>\n          \n        </div>\n      </div>\n\n      <p class="input-helper mt-1.5" for="session_password" role="alert" data-js-module-id="guest-input__message"></p>\n    </div>\n  \n\n        <input name="session_redirect" value="https://www.linkedin.com/jobs/view/lead-sales-engineer-enterprise-at-altana-3909920006" type="hidden">\n\n<!---->      </div>\n\n      <div data-id="sign-in-form__footer" class="flex justify-between\n          items-center mt-[16px]">\n        <a data-id="sign-in-form__forgot-password" class="font-sans text-md font-bold link leading-regular\n            " href="https://www.linkedin.com/uas/request-password-reset?trk=public_jobs_save-job_forgot_password" data-tracking-control-name="public_jobs_save-job_forgot_password" data-tracking-will-navigate>Forgot password?</a>\n\n<!---->\n        <input name="trk" value="public_jobs_save-job_sign-in-submit" type="hidden">\n        <button class="btn-md btn-primary flex-shrink-0 cursor-pointer\n            ml-[8px]" data-id="sign-in-form__submit-btn" data-tracking-control-name="public_jobs_save-job_sign-in-submit-btn" data-tracking-client-ingraph data-tracking-litms type="submit">\n          Sign in\n        </button>\n      </div>\n<!---->    </form>\n<!----><!---->  \n    </div>\n  \n    </div>\n  \n  \n      \n            </div>\n\n<!---->          </section>\n        </div>\n      </div>\n    </div>\n  \n  \n      \n              </div>\n            </div>\n\n<!---->          </div>\n\n          \n\n    \n    \n    \n    \n    \n    \n    \n    \n    \n    \n    \n    \n    \n\n      <div class="ellipsis-menu absolute right-0 top-0 top-card-layout__ellipsis-menu mr-1 papabear:mt-0.5 papabear:mr-2">\n        \n\n    \n\n    <div class="collapsible-dropdown flex items-center relative hyphens-auto">\n          \n            <button class="ellipsis-menu__trigger\n                collapsible-dropdown__button btn-md btn-tertiary cursor-pointer\n                !py-[6px] !px-1 flex items-center rounded-[50%]\n                \n                " aria-expanded="false" aria-label="Open menu" data-tracking-control-name="public_jobs_ellipsis-menu-trigger" tabindex="0">\n              <icon class="ellipsis-menu__trigger-icon m-0 p-0 centered-icon" data-delayed-url="https://static.licdn.com/aero-v1/sc/h/671xosfpvk4c0kqtyl87hashi"></icon>\n            </button>\n          \n\n        <ul class="collapsible-dropdown__list hidden container-raised absolute w-auto overflow-y-auto flex-col items-stretch z-1 bottom-auto top-[100%]" role="menu" tabindex="-1">\n          \n              \n\n                <li class="ellipsis-menu__item border-t-1 border-solid border-color-border-low-emphasis first-of-type:border-none flex">\n                  \n\n    \n    \n\n    \n\n    \n\n    <a href="/uas/login?fromSignIn=true&amp;session_redirect=https%3A%2F%2Fwww.linkedin.com%2Fjobs%2Fview%2Flead-sales-engineer-enterprise-at-altana-3909920006&amp;trk=public_jobs_ellipsis-menu-semaphore-sign-in-redirect&amp;guestReportContentType=JOB&amp;_f=guest-reporting" data-tracking-control-name="public_jobs_ellipsis-menu-semaphore-sign-in-redirect" data-tracking-will-navigate data-item-type="semaphore" data-semaphore-content-type="JOB" data-semaphore-content-urn="urn:li:jobPosting:3909920006" data-semaphore-tracking-prefix="public_jobs_ellipsis-menu-semaphore" data-is-logged-in="false" data-modal="semaphore__toggle" class="semaphore__toggle visited:text-color-text-secondary ellipsis-menu__semaphore ellipsis-menu__item-button flex items-center w-full p-1 cursor-pointer font-sans text-sm font-bold link-styled focus:link-styled link:no-underline active:bg-color-background-container-tint focus:bg-color-background-container-tint hover:bg-color-background-container-tint outline-offset-[-2px]">\n<!---->        \n                      <icon class="ellipsis-menu__item-icon text-color-text h-[24px] w-[24px] mr-1" data-delayed-url="https://static.licdn.com/aero-v1/sc/h/iq0x9q37wj214o129ai1yjut">\n                      </icon>\n                      Report this job\n                    \n    </a>\n\n<!---->  \n                </li>\n<!---->          \n        </ul>\n\n<!---->    </div>\n  \n\n      </div>\n  \n\n<!---->      </div>\n    </section>\n  \n  \n\n    <div class="decorated-job-posting__details">\n<!---->\n      \n    \n    \n    \n    \n    \n\n    \n    <section class="core-section-container my-3 description">\n<!---->\n<!---->\n<!---->\n      <div class="core-section-container__content break-words">\n        \n      \n    \n    \n\n<!---->  \n\n      <div class="description__text description__text--rich">\n        \n    \n    \n    \n\n    <section class="show-more-less-html" data-max-lines="5">\n        <div class="show-more-less-html__markup show-more-less-html__markup--clamp-after-5\n            relative overflow-hidden">\n          Altana provides the world’s only dynamic, intelligent map of the global supply chain - the Altana Atlas - using AI and machine learning models to connect with and learn from massive sets of public and private data. Through the Atlas, companies and governments can understand the distant origins of products well beyond their own direct suppliers; discover trading relationships and national security risks deep in their networks; measure labor and environmental impacts; identify related risks and opportunities; ensure effective compliance and enforcement with trade requirements; and collaborate to manage all of it.<br><br>We have built a fundamental understanding of how the world’s economy works, and the implications for global resiliency, sustainability and opportunity are enormous. Backed by leading investors and used by the world’s most important organizations (Maersk, US Customs and Border Protection, Boston Scientific, and more), Altana’s mission is to power a new era of globalization organized around trusted supply chain networks.<br><br>This is a lofty mission, and our success depends on building a diverse, global team and creating an environment in which they can thrive. We operate in accordance with our values: we focus on value creation, not capture; we foster diversity and embrace difference; we embrace reality; we get things done; we amaze our clients. When you join Altana, you’ll be joining a vibrant, collaborative team working together to solve complex problems with the potential for global societal impact.<br><br><strong>The Opportunity at Altana<br><br></strong>As we continue to scale our Enterprise vertical, we are seeking a dynamic and experienced Sales Engineer to join our team.<br><br>As a Sales Engineer at Altana Technologies, you\'ll be at the forefront of our sales initiatives, playing a crucial role in translating technical jargon into practical value for our clients and partners. This role requires a perfect blend of technical acumen and interpersonal skills, as you will be tasked with presenting our innovative solutions to diverse audiences, ranging from technical contributors to executives.<br><br>You\'ll be working closely with various teams, including Product Management, Engineering, and Marketing, ensuring our solutions align with customer needs and market trends. You\'ll also contribute to the continuous improvement of our products and marketing strategies.<br><br>This position reports VP of Enterprise and offers an exciting opportunity to contribute to our growing business.<br><br><strong>You Will<br><br></strong><ul><li>Conduct technical presentations of Altana’s solutions and future vision to executives and IT leaders at prospective customers. </li><li>Provide pre-sales technical support and guidance, addressing customer inquiries, conducting product training, and resolving any technical issues.</li><li>Develop and deliver high-quality proposals, technical documentation, and other sales-related materials to assist in the sales process.</li><li>Assist in post-sales activities as needed, ensuring smooth customer onboarding and successful implementation of our solutions.<br><br></li></ul><strong>You Have<br><br></strong><ul><li>Experience working in a pre-sales environment working directly with account executives on enterprise accounts; SaaS or PaaS products preferred </li><li>Excellent presentation skills, with the ability to communicate effectively to both technical and executive audiences, whether it\'s an impromptu whiteboard discussion or a prepared presentation and demo.</li><li>Broad experience with large-scale database and/or data warehouse technologies, ETL, analytics, and cloud technologies.</li><li>The ability to correlate a customer’s specific business problems with Altana Technologies\' solutions.</li><li>A university degree in computer science, engineering, mathematics, or related fields, or equivalent experience is preferred.</li><li>You possess a passion for tackling complex challenges within global trade</li><li>Hands-on expertise with SQL and/or Python<br><br></li></ul>This role can be based in any of our Altana hub locations, with hybrid work flexibility (listed in order of preference): New York City, Washington D.C., Boston, London or San Francisco<br><br>Why it’s great to work at Altana<br><br><ul><li>We love to collaborate, and we win as a team!</li><li>We are committed to engineering excellence</li><li>We value personal and professional development</li><li>We learn from diverse backgrounds and perspectives</li><li>We impact the world, from enabling developing countries to identifying drug traffickers<br><br></li></ul>At Altana, we believe that a diverse workforce enables greater creativity, performance, and adaptability. We’re proud to be an equal opportunity employer and welcome you to join us as you are. Our employment opportunities and decisions are based on business needs and individual qualifications, without regard to race, color, religious creed, national origin, ancestry, age, physical or mental disability, medical condition, marital status, sexual orientation, gender identity or expression, genetic information, family care or medical leave status, military or veteran status, or any other characteristic protected by the laws or regulations in the areas in which we operate. We prohibit discrimination and harassment of any type, in any situation.\n        </div>\n\n        \n\n    \n    \n    \n\n    <button class="show-more-less-html__button show-more-less-button\n        show-more-less-html__button--more\n        ml-0.5" data-tracking-control-name="public_jobs_show-more-html-btn" aria-label="i18n_show_more" aria-expanded="false">\n<!---->\n        \n            Show more\n          \n\n          <icon class="show-more-less-html__button-icon show-more-less-button-icon" data-delayed-url="https://static.licdn.com/aero-v1/sc/h/cyolgscd0imw2ldqppkrb84vo"></icon>\n    </button>\n  \n\n        \n\n    \n    \n    \n\n    <button class="show-more-less-html__button show-more-less-button\n        show-more-less-html__button--less\n        ml-0.5" data-tracking-control-name="public_jobs_show-less-html-btn" aria-label="i18n_show_less" aria-expanded="true">\n<!---->\n        \n            Show less\n          \n\n          <icon class="show-more-less-html__button-icon show-more-less-button-icon" data-delayed-url="https://static.licdn.com/aero-v1/sc/h/4chtt12k98xwnba1nimld2oyg"></icon>\n    </button>\n  \n<!---->    </section>\n  \n      </div>\n\n      <ul class="description__job-criteria-list">\n        <li class="description__job-criteria-item">\n          <h3 class="description__job-criteria-subheader">\n            Seniority level\n          </h3>\n          <span class="description__job-criteria-text description__job-criteria-text--criteria">\n            Mid-Senior level\n          </span>\n        </li>\n        <li class="description__job-criteria-item">\n          <h3 class="description__job-criteria-subheader">\n            Employment type\n          </h3>\n          <span class="description__job-criteria-text description__job-criteria-text--criteria">\n            Full-time\n          </span>\n        </li>\n          <li class="description__job-criteria-item">\n            <h3 class="description__job-criteria-subheader">\n              Job function\n            </h3>\n            <span class="description__job-criteria-text description__job-criteria-text--criteria">\n              Sales and Business Development\n            </span>\n          </li>\n          <li class="description__job-criteria-item">\n            <h3 class="description__job-criteria-subheader">\n              Industries\n            </h3>\n            <span class="description__job-criteria-text description__job-criteria-text--criteria">\n            Software Development\n            </span>\n          </li>\n      </ul>\n    \n      </div>\n    </section>\n  \n  \n\n        \n    \n\n    \n\n      \n    <section class="core-section-container my-3 find-a-referral">\n<!---->\n<!---->\n<!---->\n      <div class="core-section-container__content break-words">\n        \n        \n      \n    <div class="face-pile flex">\n      <div class="face-pile__images-container self-start flex-shrink-0 mr-1 leading-[1]">\n          \n      <img class="inline-block relative\n          rounded-[50%]\n          w-4 h-4\n           face-pile__image border-1 border-solid border-color-transparent -ml-2 first:ml-0" data-delayed-url="https://static.licdn.com/aero-v1/sc/h/ccme3th179hovxui57zwev0p3" data-ghost-classes="bg-color-entity-ghost-background" data-ghost-url="https://static.licdn.com/aero-v1/sc/h/9c8pery4andzj6ohjkjp54ma2" alt>\n  \n          \n      <img class="inline-block relative\n          rounded-[50%]\n          w-4 h-4\n           face-pile__image border-1 border-solid border-color-transparent -ml-2 first:ml-0" data-delayed-url="https://static.licdn.com/aero-v1/sc/h/ejhf1wl85h7r4afiv43sk1a0k" data-ghost-classes="bg-color-entity-ghost-background" data-ghost-url="https://static.licdn.com/aero-v1/sc/h/9c8pery4andzj6ohjkjp54ma2" alt>\n  \n          \n      <img class="inline-block relative\n          rounded-[50%]\n          w-4 h-4\n           face-pile__image border-1 border-solid border-color-transparent -ml-2 first:ml-0" data-delayed-url="https://static.licdn.com/aero-v1/sc/h/zq1567h0ccgosa9ep0hbzee9" data-ghost-classes="bg-color-entity-ghost-background" data-ghost-url="https://static.licdn.com/aero-v1/sc/h/9c8pery4andzj6ohjkjp54ma2" alt>\n  \n      </div>\n        \n          \n            <div class="find-a-referral__cta-container">\n              <p>Referrals increase your chances of interviewing at Altana by 2x</p>\n              <a class="find-a-referral__cta" href="https://www.linkedin.com/login?session_redirect=https%3A%2F%2Fwww%2Elinkedin%2Ecom%2Fsearch%2Fresults%2Fpeople%2F%3FfacetCurrentCompany%3D14031310&amp;emailAddress=&amp;fromSignIn=&amp;trk=public_jobs_find-a-referral-cta" data-impression-id="public_jobs_find-a-referral-cta" data-tracking-control-name="public_jobs_find-a-referral-cta" data-tracking-will-navigate>\n                See who you know\n              </a>\n            </div>\n          \n        \n    </div>\n  \n  \n      \n      </div>\n    </section>\n  \n  \n\n<!---->    </div>\n\n<!---->\n<!---->\n    <code id="decoratedJobPostingId" style="display: none"><!--"3909920006"--></code>\n      <code id="referenceId" style="display: none"><!--"dxSuWia/TGmrpNHSP+FUIw=="--></code>\n    <code id="joinUrlWithRedirect" style="display: none"><!--"https://www.linkedin.com/signup/cold-join?source=jobs_registration&session_redirect=https%3A%2F%2Fwww.linkedin.com%2Fjobs%2Fview%2Flead-sales-engineer-enterprise-at-altana-3909920006&trk=public_jobs_save-job"--></code>\n  \n
"""

HTML_WITH_SALARY = """
<div class="salary compensation__salary">
    $50,000 - $70,000
</div>
"""
HTML_WITHOUT_SALARY = """
<div class="no-salary">
    No salary information available
</div>
"""


@pytest.fixture
def job_posting_soup():
    return BeautifulSoup(HTML_CONTENT, "html.parser")


@pytest.fixture
def salary_soup():
    return BeautifulSoup(HTML_WITH_SALARY, "html.parser")


@pytest.fixture
def no_salary_soup():
    return BeautifulSoup(HTML_WITHOUT_SALARY, "html.parser")


def test_extract_job_title(job_posting_soup):
    assert (
        JobPostingDataExtractor._extract_job_title(job_posting_soup)
        == "Lead Sales Engineer, Enterprise"
    )


def test_extract_company_name(job_posting_soup):
    assert JobPostingDataExtractor._extract_company_name(job_posting_soup) == "Altana"


def test_extract_job_location(job_posting_soup):
    assert (
        JobPostingDataExtractor._extract_job_location(job_posting_soup)
        == "Washington, DC"
    )


def test_extract_seniority_level(job_posting_soup):
    extractor = JobPostingDataExtractor()
    with patch.object(SeniorityLevelsEnum, "get_id", return_value=4):
        assert extractor._extract_seniority_level(job_posting_soup) == 4


def test_extract_employment_type(job_posting_soup):
    extractor = JobPostingDataExtractor()
    with patch.object(EmploymentTypesEnum, "get_id", return_value=1):
        assert extractor._extract_employment_type(job_posting_soup) == 1


def test_extract_job_functions(job_posting_soup):
    extractor = JobPostingDataExtractor()
    assert extractor._extract_job_functions(job_posting_soup) == [
        "Sales",
        "Business Development",
    ]


def test_extract_salary_range_with_salary(salary_soup):
    extractor = JobPostingDataExtractor()
    assert extractor._extract_salary_range(salary_soup) == (50000, 70000)


def test_extract_salary_range_without_salary(no_salary_soup):
    extractor = JobPostingDataExtractor()
    assert extractor._extract_salary_range(no_salary_soup) is None


def test_extract_industries(job_posting_soup):
    extractor = JobPostingDataExtractor()
    assert extractor._extract_industries(job_posting_soup) == ["Software Development"]


def test_extract_job_description(job_posting_soup):
    expected_description = "Altana provides the world’s only dynamic, intelligent map of the global supply chain - the Altana Atlas - using AI and machine learning models to connect with and learn from massive sets of public and private data. Through the Atlas, companies and governments can understand the distant origins of products well beyond their own direct suppliers; discover trading relationships and national security risks deep in their networks; measure labor and environmental impacts; identify related risks and opportunities; ensure effective compliance and enforcement with trade requirements; and collaborate to manage all of it.\n\nWe have built a fundamental understanding of how the world’s economy works, and the implications for global resiliency, sustainability and opportunity are enormous. Backed by leading investors and used by the world’s most important organizations (Maersk, US Customs and Border Protection, Boston Scientific, and more), Altana’s mission is to power a new era of globalization organized around trusted supply chain networks.\n\nThis is a lofty mission, and our success depends on building a diverse, global team and creating an environment in which they can thrive. We operate in accordance with our values: we focus on value creation, not capture; we foster diversity and embrace difference; we embrace reality; we get things done; we amaze our clients. When you join Altana, you’ll be joining a vibrant, collaborative team working together to solve complex problems with the potential for global societal impact.\n\nThe Opportunity at Altana\n\n\nAs we continue to scale our Enterprise vertical, we are seeking a dynamic and experienced Sales Engineer to join our team.\n\nAs a Sales Engineer at Altana Technologies, you'll be at the forefront of our sales initiatives, playing a crucial role in translating technical jargon into practical value for our clients and partners. This role requires a perfect blend of technical acumen and interpersonal skills, as you will be tasked with presenting our innovative solutions to diverse audiences, ranging from technical contributors to executives.\n\nYou'll be working closely with various teams, including Product Management, Engineering, and Marketing, ensuring our solutions align with customer needs and market trends. You'll also contribute to the continuous improvement of our products and marketing strategies.\n\nThis position reports VP of Enterprise and offers an exciting opportunity to contribute to our growing business.\n\nYou Will\n\n\n- Conduct technical presentations of Altana’s solutions and future vision to executives and IT leaders at prospective customers.\n- Provide pre-sales technical support and guidance, addressing customer inquiries, conducting product training, and resolving any technical issues.\n- Develop and deliver high-quality proposals, technical documentation, and other sales-related materials to assist in the sales process.\n- Assist in post-sales activities as needed, ensuring smooth customer onboarding and successful implementation of our solutions.\n\nYou Have\n\n\n- Experience working in a pre-sales environment working directly with account executives on enterprise accounts; SaaS or PaaS products preferred\n- Excellent presentation skills, with the ability to communicate effectively to both technical and executive audiences, whether it's an impromptu whiteboard discussion or a prepared presentation and demo.\n- Broad experience with large-scale database and/or data warehouse technologies, ETL, analytics, and cloud technologies.\n- The ability to correlate a customer’s specific business problems with Altana Technologies' solutions.\n- A university degree in computer science, engineering, mathematics, or related fields, or equivalent experience is preferred.\n- You possess a passion for tackling complex challenges within global trade\n- Hands-on expertise with SQL and/or Python\n\nThis role can be based in any of our Altana hub locations, with hybrid work flexibility (listed in order of preference): New York City, Washington D.C., Boston, London or San Francisco\n\nWhy it’s great to work at Altana\n\n- We love to collaborate, and we win as a team!\n- We are committed to engineering excellence\n- We value personal and professional development\n- We learn from diverse backgrounds and perspectives\n- We impact the world, from enabling developing countries to identifying drug traffickers\n\nAt Altana, we believe that a diverse workforce enables greater creativity, performance, and adaptability. We’re proud to be an equal opportunity employer and welcome you to join us as you are. Our employment opportunities and decisions are based on business needs and individual qualifications, without regard to race, color, religious creed, national origin, ancestry, age, physical or mental disability, medical condition, marital status, sexual orientation, gender identity or expression, genetic information, family care or medical leave status, military or veteran status, or any other characteristic protected by the laws or regulations in the areas in which we operate. We prohibit discrimination and harassment of any type, in any situation."
    assert (
        JobPostingDataExtractor._extract_job_description(job_posting_soup)
        == expected_description
    )


def test_extract_single_job(job_posting_soup, db: Session):
    extractor = JobPostingDataExtractor()
    job_id = "3909920006"

    with patch.object(
        JobPostingDataExtractor,
        "_extract_job_title",
        return_value="Lead Sales Engineer, Enterprise",
    ):
        with patch.object(
            JobPostingDataExtractor,
            "_extract_job_location",
            return_value="Washington, DC",
        ):
            with patch.object(
                JobPostingDataExtractor, "_extract_seniority_level", return_value=4
            ):
                with patch.object(
                    JobPostingDataExtractor, "_extract_employment_type", return_value=1
                ):
                    with patch.object(
                        JobPostingDataExtractor,
                        "_extract_job_description",
                        return_value="Job description",
                    ):
                        with patch.object(
                            JobPostingDataExtractor,
                            "_extract_company_name",
                            return_value="Altana",
                        ):
                            with patch.object(
                                JobPostingDataExtractor,
                                "_extract_company_url",
                                return_value="https://www.linkedin.com/company/altana-ai",
                            ):
                                with patch.object(
                                    JobPostingDataExtractor,
                                    "_extract_job_functions",
                                    return_value=["Sales", "Business Development"],
                                ):
                                    with patch.object(
                                        JobPostingDataExtractor,
                                        "_extract_industries",
                                        return_value=["Software Development"],
                                    ):
                                        extractor._create_job_posting(
                                            job_id, job_posting_soup
                                        )

                                        job_posting = db.exec(
                                            select(JobPostings).where(
                                                JobPostings.linkedin_id == int(job_id)
                                            )
                                        ).first()

                                        assert job_posting

                                        assert job_posting.linkedin_id == int(job_id)
                                        assert (
                                            job_posting.title
                                            == "Lead Sales Engineer, Enterprise"
                                        )
                                        assert job_posting.location == "Washington, DC"
                                        assert job_posting.seniority_level == 4
                                        assert job_posting.employment_type == 1
                                        assert (
                                            job_posting.description == "Job description"
                                        )
                                        assert job_posting.company == "Altana"
                                        assert (
                                            job_posting.company_url
                                            == "https://www.linkedin.com/company/altana-ai"
                                        )
                                        assert job_posting.job_functions == [
                                            "Sales",
                                            "Business Development",
                                        ]
                                        assert job_posting.industries == [
                                            "Software Development"
                                        ]

                                        # Clean up the created job posting
                                        db.delete(job_posting)
                                        db.commit()
